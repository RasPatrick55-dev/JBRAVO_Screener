%% [MermaidChart: run_pipeline_flow_data]
%%{init: {'theme': 'base', 'themeVariables': {'fontSize': '168px', 'fontFamily': 'Helvetica, Arial, sans-serif', 'fontWeight': '800', 'textColor': '#000000', 'primaryTextColor': '#000000', 'secondaryTextColor': '#000000', 'tertiaryTextColor': '#000000', 'lineColor': '#000000', 'nodePadding': 90}, 'flowchart': {'nodeSpacing': 80, 'rankSpacing': 140}}}%%
flowchart LR
  classDef cand fill:#f0fff4,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef metr fill:#e6f4ff,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef ml fill:#f5e9ff,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef rep fill:#fffbe6,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef db fill:#ffecec,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef note fill:#f2f2f2,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  %% DF-Candidates
  C1["DF-Candidates - DB views (source of truth)"] --> D11
  C1 --> D12

  %% DF-Metrics
  M1[DF-Metrics - JSON + DB outputs] --> D2
  M1 --> M2[/data/screener_metrics.json/]
  M1 --> M3[/data/screener_stage_fetch.json/]
  M1 --> M4[/data/screener_stage_post.json/]

  %% DF-ML
  L1[DF-ML - labels, features, predictions, eval] --> L2[/data/labels/labels_RUNDATE/]
  L1 --> L3[/data/features/features_RUNDATE/]
  L1 --> L4[/data/predictions/predictions_RUNDATE/]
  L1 --> L5[/data/ranker_eval/latest.json/]
  L1 --> L6[/data/nightly_ml_status.json/]
  API1["Alpaca Market Data API\nIEX primary, SIP fallback"] -.-> D10

  %% DF-Reports
  R1[DF-Reports - pipeline status + logs] --> R2[/data/pipeline_status.json/]
  R1 --> R3[/data/connection_health.json/]
  R1 --> R4[/data/pipeline_fresh.json/]
  R1 --> R5[/reports/pipeline_summary.json/]
  R1 --> R6[/reports/log_snips/*.err.txt/]
  R1 --> R7[/logs/pipeline.log + logs/step.*.out/]

  %% DF-DB
  D1[DF-DB - source of truth] --> D2[(PostgreSQL)]
  D2 --> D3[screener_candidates]
  D2 --> D4[backtest_results]
  D2 --> D5[metrics_daily]
  D2 --> D6[pipeline_runs]
  D2 --> D7[trades]
  D2 --> D8[top_candidates]
  D2 --> D9[ml_artifacts]
  D2 --> D10[daily_bars]
  D2 --> D11["latest_screener_candidates (view)"]
  D2 --> D12["latest_top_candidates (view)"]

  subgraph Legend
    L_cand[DF-Candidates]
    L_metr[DF-Metrics]
    L_ml[DF-ML]
    L_rep[DF-Reports]
    L_db[DF-DB]
    L_note[Note]
    L_cand --> L_metr --> L_ml --> L_rep --> L_db --> L_note
  end

  NOTE[Print A: docs/explanation/diagrams/run_pipeline_flow_process.mmd]
  NOTE -.-> C1
  class C1 cand;
  class M1,M2,M3,M4 metr;
  class L1,L2,L3,L4,L5,L6 ml;
  class R1,R2,R3,R4,R5,R6,R7 rep;
  class D1,D2,D3,D4,D5,D6,D7,D8,D9,D10,D11,D12 db;
  class NOTE note;
  class API1 note;
  class L_cand cand;
  class L_metr metr;
  class L_ml ml;
  class L_rep rep;
  class L_db db;
  class L_note note;
