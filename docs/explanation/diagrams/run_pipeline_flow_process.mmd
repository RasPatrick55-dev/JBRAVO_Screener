%% [MermaidChart: run_pipeline_flow_process]
%%{init: {'theme': 'base', 'themeVariables': {'fontSize': '168px', 'fontFamily': 'Helvetica, Arial, sans-serif', 'fontWeight': '800', 'textColor': '#000000', 'primaryTextColor': '#000000', 'secondaryTextColor': '#000000', 'tertiaryTextColor': '#000000', 'lineColor': '#000000', 'nodePadding': 90}, 'flowchart': {'nodeSpacing': 80, 'rankSpacing': 140}}}%%
flowchart LR
  classDef start fill:#f0fff4,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef decision fill:#fffbe6,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef step fill:#e6f4ff,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef warn fill:#ffecec,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef ref fill:#f5e9ff,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;
  classDef note fill:#f2f2f2,stroke:#000000,color:#000000,stroke-width:2px,padding:90px 500px,width:700px,min-width:700px;

  subgraph Section1["Section 1 - Actions"]
    direction TB
    A([Start run_pipeline])
    B[Load env + configure logging]
    D[Parse args + determine steps]
    E[Resolve run date + base dir\nensure latest headers]
    F[Prepare step args\nmerge split args + inject run_date + export bars]
    F1[Run screener\nread metrics + DB counts]
    G1["Run backtest\nbackfill bars if needed (IEX to SIP)"]
    H1[Run metrics\nsync latest + refresh trade cache]
    I1[Run label_generator]
    J1[Run ranker_eval]
    K1[Enrich + rerank candidates\nwrite nightly status]
    M[Finalize + summaries\nscreener_metrics + pipeline_status\npipeline_runs + connection health]
    O[Update equity + reload dashboard]
    END([End])
  end

  subgraph Section2["Section 2 - Questions"]
    direction TB
    C{Missing env?}
    DB_req{DB enabled?}
    S_req{Screener step missing?}
    CAND{"Zero candidates?"}
    G[Backtest step?]
    H[Metrics step?]
    I[Labels step?]
    L_bars{Labels bars present?}
    J[Ranker_eval step?]
    K[Enrich candidates flag?]
  end

  subgraph Section3["Section 3 - Errors"]
    direction TB
    C_fail[Exit rc=2]
    S_fail["Screener missing: stop + alert"]
    DB_fail["DB required: stop + error report"]
    Z_warn["Zero candidates: alert + continue"]
    L_skip["Labels skipped: missing/empty bars"]
  end

  subgraph Section4["Section 4 - References"]
    direction TB
    DF1["DF-Candidates (DB views)"]
    DF2["DF-Metrics (DB + JSON)"]
    DF3[DF-ML]
    DF4[DF-Reports]
    DF5[DF-DB tables]
    DF6["DF-API sources\nIEX primary, SIP fallback"]
  end

  subgraph Section5["Section 5 - Legend + Notes"]
    direction TB
    L_start[Start/End]
    L_decision{Decision}
    L_step[Process step]
    L_warn[Error/Exit]
    L_ref[Cross-reference]
    L_note[Note]
    L_start --> L_decision --> L_step --> L_warn --> L_ref --> L_note
    NOTE[Print B: docs/explanation/diagrams/run_pipeline_flow_data.mmd]
  end

  A --> B
  B --> C
  C -- yes --> C_fail
  C -- no --> DB_req
  DB_req -- no --> DB_fail
  DB_req -- yes --> D
  D --> S_req
  S_req -- yes --> S_fail
  S_req -- no --> E
  E --> F
  F --> F1
  F1 --> CAND
  CAND -- yes --> Z_warn
  CAND -- no --> G
  Z_warn --> G
  G -- yes --> G1
  G -- no --> H
  G1 --> H
  H -- yes --> H1
  H -- no --> I
  H1 --> I
  I -- yes --> L_bars
  I -- no --> J
  L_bars -- yes --> I1
  L_bars -- no --> L_skip
  L_skip --> J
  I1 --> J
  J -- yes --> J1
  J -- no --> K
  J1 --> K
  K -- yes --> K1
  K -- no --> M
  K1 --> M
  M --> O
  O --> END

  F1 -.-> DF1
  F1 -.-> DF6
  G1 -.-> DF1
  G1 -.-> DF6
  H1 -.-> DF2
  I1 -.-> DF3
  J1 -.-> DF3
  K1 -.-> DF3
  M -.-> DF4
  M -.-> DF5
  DF1 -.-> NOTE

  class A,END start;
  class C,DB_req,S_req,CAND,G,H,I,L_bars,J,K decision;
  class C_fail,S_fail,DB_fail,Z_warn,L_skip warn;
  class B,D,E,F,F1,G1,H1,I1,J1,K1,M,O step;
  class DF1,DF2,DF3,DF4,DF5,DF6 ref;
  class NOTE note;
  class L_start start;
  class L_decision decision;
  class L_step step;
  class L_warn warn;
  class L_ref ref;
  class L_note note;
